name: Release And Publish NuGet Packages

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Add GitHub Packages source
        run: dotnet nuget add source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --name github --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text

      - name: Build and push packages
        run: dotnet build Components.sln -c Release -p:ContinuousIntegrationBuild=true -p:VersionPrefix=${{ steps.version.outputs.VERSION }}

      - name: Collect published packages
        id: packages
        run: |
          PACKAGES=$(find . -path '*/bin/Release/*.nupkg' -name '*.nupkg' ! -name '*.symbols.nupkg' | \
            xargs -I {} basename {} .nupkg | \
            sed 's/\.\([0-9]\)/ \1/' | \
            awk '{print "- ["$1"](https://github.com/${{ github.repository }}/pkgs/nuget/"$1")"}' | \
            sort)
          echo "LIST<<EOF" >> $GITHUB_OUTPUT
          echo "$PACKAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update release with package links
        if: github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_BODY="## Published Packages

          ${{ steps.packages.outputs.LIST }}"

          # Check if release exists for this tag
          if gh release view "${{ github.ref_name }}" &>/dev/null; then
            gh release edit "${{ github.ref_name }}" --notes "$RELEASE_BODY"
          else
            gh release create "${{ github.ref_name }}" --title "${{ github.ref_name }}" --notes "$RELEASE_BODY"
          fi
